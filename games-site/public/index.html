<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultimate Game Stash</title>
<link rel="stylesheet" href="/style.css">
</head>
<body>
<header>
  <h1>Ultimate Game Stash</h1>
  <input type="text" id="search" placeholder="Search games..." />
  <button id="prevPage">Prev</button>
  <button id="nextPage">Next</button>
  <span id="pageInfo"></span>
</header>
<main id="gameList"></main>

<script>
let currentPage = 1;
const limit = 50;

async function loadGames(page = 1) {
  const search = document.getElementById("search").value;
  try {
    const res = await fetch(`/games+img.json?page=${page}&limit=${limit}&search=${encodeURIComponent(search)}`);
    const text = await res.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      console.error("Failed to parse JSON:", text);
      throw e;
    }

    if (!data.games) throw new Error("Invalid response");

    const gameList = document.getElementById("gameList");
    gameList.innerHTML = "";
    data.games.forEach(g => {
      const div = document.createElement("div");
      div.className = "game";
      div.innerHTML = `
        <img src="${g.image}" alt="${g.title}" />
        <a href="${g.url}" target="_blank">${g.title}</a>
      `;
      gameList.appendChild(div);
    });

    // Update pagination info
    const totalPages = Math.ceil(data.total / limit);
    document.getElementById("pageInfo").textContent = `Page ${data.page} / ${totalPages}`;
    currentPage = data.page;

    // Disable/enable buttons
    document.getElementById("prevPage").disabled = currentPage <= 1;
    document.getElementById("nextPage").disabled = currentPage >= totalPages;
  } catch (err) {
    console.error("Failed to load games:", err);
    document.getElementById("gameList").innerHTML = "<p>Error loading games.</p>";
  }
}

// Event listeners
document.getElementById("prevPage").addEventListener("click", () => {
  if (currentPage > 1) loadGames(currentPage - 1);
});
document.getElementById("nextPage").addEventListener("click", () => loadGames(currentPage + 1));
document.getElementById("search").addEventListener("input", () => loadGames(1));

// Initial load
loadGames();
</script>
</body>
</html>
