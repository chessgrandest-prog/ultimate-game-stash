<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Game Library</title>
<link rel="stylesheet" href="/style.css">
</head>
<body>
<header>
  <h1>Game Library</h1>
  <div class="controls">
    <input id="search" type="text" placeholder="Search games...">
    <button id="themeToggle">üåô Toggle Theme</button>
    <label class="favorites-toggle">
      <input type="checkbox" id="showFavorites">
      Show Favorites
    </label>
  </div>
</header>

<main>
  <section id="featuredSection">
    <h2>Featured Games</h2>
    <div id="featuredGrid" class="games-grid"></div>
  </section>

  <section id="allGamesSection">
    <h2>All Games</h2>
    <div id="gamesGrid" class="games-grid"></div>

    <!-- Pagination controls -->
    <div style="text-align:center; margin: 10px;">
      <button id="prevPage" onclick="prevPage()">Previous</button>
      <span id="pageInfo"></span>
      <button id="nextPage" onclick="nextPage()">Next</button>
    </div>
  </section>
</main>

<footer>
  <p id="totalGames"></p>
</footer>

<script>
const DEFAULT_THUMBNAIL = 'https://via.placeholder.com/200x120?text=Game';
const FAVORITES_KEY = 'favoriteGames';
let favoriteGames = JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');

// Theme toggle
let darkMode = false;
const body = document.body;
document.getElementById('themeToggle').addEventListener('click', () => {
  darkMode = !darkMode;
  body.classList.toggle('dark', darkMode);
});

// Favorites filter
const showFavoritesCheckbox = document.getElementById('showFavorites');
showFavoritesCheckbox.addEventListener('change', () => { currentPage = 1; fetchGames(); });

// Pagination
const GAMES_PER_PAGE = 100;
let currentPage = 1;
let totalGames = 0;
let currentGames = [];

// Toggle favorite
function toggleFavorite(gameUrl) {
  if (favoriteGames.includes(gameUrl)) {
    favoriteGames = favoriteGames.filter(url => url !== gameUrl);
  } else {
    favoriteGames.push(gameUrl);
  }
  localStorage.setItem(FAVORITES_KEY, JSON.stringify(favoriteGames));
  renderPage();
}

// Render a game card
function renderCard(game) {
  const gamePath = encodeURIComponent(game.url.split('/').pop());
  const thumbnail = game.image || DEFAULT_THUMBNAIL;
  const isFav = favoriteGames.includes(game.url);

  return `
    <div class="game-card">
      <a href="/game/${gamePath}" target="_blank">
        <div class="thumbnail-container">
          <img src="${thumbnail}" alt="${game.title}" loading="lazy"
               onerror="this.src='${DEFAULT_THUMBNAIL}'">
        </div>
        <div class="game-title">${game.title}</div>
      </a>
      <button class="favorite-btn" onclick="toggleFavorite('${game.url}')">
        ${isFav ? '‚≠ê' : '‚òÜ'}
      </button>
    </div>
  `;
}

// Render the current page
function renderPage() {
  document.getElementById('gamesGrid').innerHTML = currentGames.map(renderCard).join('');
  document.getElementById('featuredGrid').innerHTML = currentGames.slice(0, 5).map(renderCard).join('');

  document.getElementById('totalGames').textContent =
    `Showing page ${currentPage} of ${Math.ceil(totalGames / GAMES_PER_PAGE)} (Total games: ${totalGames})`;

  document.getElementById('pageInfo').textContent = `Page ${currentPage}`;
  document.getElementById('prevPage').disabled = currentPage === 1;
  document.getElementById('nextPage').disabled = currentPage * GAMES_PER_PAGE >= totalGames;
}

// Fetch games from Worker paginated endpoint
async function fetchGames() {
  try {
    const searchQuery = document.getElementById('search').value;
    const favFilter = showFavoritesCheckbox.checked ? '1' : '0';
    const favList = JSON.stringify(favoriteGames);

    const res = await fetch(`/games+img.json?page=${currentPage}&limit=${GAMES_PER_PAGE}&search=${encodeURIComponent(searchQuery)}&favorites=${favFilter}&favList=${encodeURIComponent(favList)}`);
    const data = await res.json();

    totalGames = data.total;
    currentGames = data.games;

    renderPage();
  } catch (err) {
    console.error(err);
    document.getElementById('totalGames').textContent = 'Failed to load games.';
  }
}


// Pagination handlers
function nextPage() { currentPage++; fetchGames(); }
function prevPage() { currentPage--; fetchGames(); }

// Initialize
fetchGames();
document.getElementById('search').addEventListener('input', () => { currentPage = 1; fetchGames(); });
</script>
</body>
</html>
